﻿# BlobStore #Blob storage build upon rocksDB with a WiscKey like storage system## Arbeitsweise: ##zunächst werden die Daten in das vLog geschrieben. Für alle Familien zusammen gibt es nur einen Satz an vLog Dateien. Das vLog ist eine einfache sequentielle Datei. Zunächst kommt der Trenner, dann die vLog Beschreibung (vLogDescriptor : KEY, FAMILY, CHUNKNO, RETENTION, TIMESTAMP), danach die Binärdaten. Während der Ablage der Binärdaten wird ein SHA-256 Hash gebildet und dieser inkl. der geschriebenen Länge dann dahinter gehängt. (vLogPostFix: LENGTH, HASH)Bei Chuncking werden die einzenlen Chunks direkt abgelegt.Nach erfolgreichem Schreibvorgang wird die Pos auf die vLogDescription im vLOG und der Hash zusammen mit den anderen Daten in die RocksDB unter der Familie eingetragen.Die Familie ist damit ein Mandantentrenner## RocksDB ##In der RocksDB wird pro Key ein Eintrag geschrieben. Blobentry: KEY, FAMILY, vLOG, vCnt, POSITION, LENGTH, HASH, DELETED, RETENTION## Löschvorgang ##Ein Löschvorgang besteht im Wesentlichen daraus, in der RocksDB den Eintrag als gelöscht zu markieren.## Hintergrund Tasks ##### vLog CompactionDer Hintergrundtaks für das vLog prüft die für die Compaction des vLog geltenden Bestimmungen. Ist eine davon betroffen, wird das vLog für schreibenden Zugriff gesperrt und der entsprechende Compactvorgang angestoßen.### Container Compaction ###Ein Hintergrundtask geht dann durch alle Container und berechnet, wieviel Freiplatz in dem jeweiligen Container enthalten ist. Ist dieser größer als vCntDeleteTreshHold (Prozentangabe) wird der Container komprimiert. Grundlage ist die Bytegröße. Evtl. wird er danach für Schreiben wieder geöffnet.### Container Compression ###Ein Hintergrundtask geht durch alle Container und berechnet, ob der Container zur Komprimierung ansteht. Wenn ja, wird für diesen Container die Comprimierung gestartet. Danach ist im Container nur noch Lesen erlaubt. Eine evtl. Compaction kann aber durchgeführt werden.## Compact vLog ##Ein Compact Vorgang wird initiiert, wenn eine vLog Datei die kritische Größe erreicht hat, vlogMaxSize oder die max. Anzahl der Dokumente erreicht hat, vlogMaxCount oder der letzte schreibende Zugriff > ist als vLogAge. Dabei werden dann alle Dokumente im vLog der Reihe nach verarbeitet. 
- Anlesen der vlogDescription- Checken des sDB Eintrages  - vlog file identisch ? compact : recovery  - key identisch -> compact- übertragen in vContainer, bilden von Hash- check des Hashs ? weiter : Fehlerbehandlung- update des DB Eintrages### Retention ###Ein Hintergrund Task wertet die Retention der Einträge aus. Dabei werden alle Dokumenteneinträge der DB mit Retention verarbeitet. Ist die Retention abgelaufen, wird das Dokument als gelöscht markiert.-> Family: <name>_retention## Compact Container ##Ein Compact-Vorgang wird für einen Container im Hintergrund aufgerufen. Dabei werden folgende Schritte durchgeführt
- Erzeugen eines neuen Containers- Anlesen der vcnt Description- Checken des sDB Eintrages  - vcnt.container identisch ? compress : recovery  - key identisch -> compress- übertragen in den neuen vContainer- Eintragen in dLog File- alter Container komplett verarbeitet, neuen Container registrieren- update der DB Einträge (Bulk update)- alten Container entsorgen## Kompression ##Ab einem gewissen Alter (vCntCompressAge) werden Container automatisch komprimiert. Als Verfahren wird vCntCompressionMode verwendet.- Erzeugen eines neuen Containers- Anlesen der vcnt Description- Checken des sDB Eintrages  - vcnt.container identisch ? compress : recovery  - key identisch -> compress- übertragen in den neuen vContainer, dabei komprimieren- Eintragen in dLog File- alter Container komplett verarbeitet, neuen Container registrieren- update der DB Einträge (Bulk update)- alten Container entsorgen## Aufsetzen nach Ausfall ##Für das Aufsetzten nach einem Ausfall gibt es mehrere Steps, die vom System automatisch ausgeführt werden.Zunächst einmal wir die Version der Ablage geprüft. Die Version steht in der CONFIG Datei. Falls die Version nicht mit der aktuellen Version übereinstimmt, wird automatisch ein Versionsupdate ausgeführt.